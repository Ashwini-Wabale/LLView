# Copyright (c) 2023 Forschungszentrum Juelich GmbH.
# This file is part of LLview. 
#
# This is an open source software distributed under the GPLv3 license. More information see the LICENSE file at the top level.
#
# Contributions must follow the Contributor License Agreement. More information see the CONTRIBUTING.md file at the top level.
#
# Contributors:
#    Wolfgang Frings (Forschungszentrum Juelich GmbH) 

#################################################
# check and register files generated by jureptool
#################################################
- dataset:
    name:                jureptool_pdf
    set:                 json_jureptool
    FORALL:              'P,U,J:VAR_project_user_job'
    filepath:            '$outputdir/projects/$P/$U/jobreport_${systemname}_${P}_${U}_${J}.pdf'
    column_filemap:      'P:account,U:owner,J:jobid'
    sql_where:           'D1.jobid IN (SELECT jobid FROM updatedjobs) and (ts>0)'
    format:              'registerfile'
    data_database:       'jobreport'
    data_table:          'joblist, jobmetrics, jobscores, jobfiles'
    data_table_join_col: 'jobid'
    stat_database:       'jobreport'
    stat_table:          'datasetstat_job_jureptool_pdf'
    mngt_actions:        'archive_jobs_files,compress_finished_files'

- dataset:
    name:                jureptool_html
    set:                 json_jureptool
    FORALL:              'P,U,J:VAR_project_user_job'
    filepath:            '$outputdir/projects/$P/$U/jobreport_${systemname}_${P}_${U}_${J}.html.gz'
    column_filemap:      'P:account,U:owner,J:jobid'
    sql_where:           'D1.jobid IN (SELECT jobid FROM updatedjobs) and (ts>0)'
    format:              'registerfile'
    data_database:       'jobreport'
    data_table:          'joblist, jobmetrics, jobscores, jobfiles'
    data_table_join_col: 'jobid'
    stat_database:       'jobreport'
    stat_table:          'datasetstat_job_jureptool_html'
    mngt_actions:        'archive_jobs_files'

- dataset:
    name: jobid_map_dat
    set:        json_jureptool
    filepath:   '$outputdir/sec_files/jobids.txt.gz'
    columns:        'jobid,account,owner'
    header:         '[jobid_map]'
    format_str:      '%s = %s,%s'
    format:         'dat'
    column_ts:      'ts'
    sql_where:      'owner != "unknown"'
    renew:           always
    data_database:   jobreport
    data_table:      joblist
    stat_database:   jobreport_stat_steptimings
    stat_table:      datasetstat

    
###############################
# Input files for jureptool
###############################
- dataset:
    name:                jureptool_json
    set:                 json_jureptool
    FORALL:              'P,U,J:VAR_project_user_job'
    filepath:            '$outputdir/projects/$P/$U/jobreport_${P}_${U}_${J}.json'
    column_filemap:      'P:account,U:owner,J:jobid'
    sql_where:           'D1.jobid IN (SELECT jobid FROM updatedjobs) and (ts>0)'
    format:              'json'
    json_type:           'single_entry'
    data_database:       'jobreport'
    data_table:          'joblist, jobmetrics, jobscores, jobfiles'
    data_table_join_col: 'jobid'
    stat_database:       'jobreport_json_stat'
    stat_table:          'datasetstat_job_jureptool'
    mngt_actions:        'archive_jobs_files,compress_finished_files'
    column_groups:       
      job:  'jobid,owner,account,numnodes,runtime->runtimehm,runtime,starttime,waittime,queuedate,
             endtime->estendtime,endtime->endedhm,wall->wallh,wall->wallhm,name,gpu_numgpus->numgpus,queue,nodelist,runtimeperc,
             ts->updatetime,jobid->system,finished,comment,command,
             lastts->lastupdate,lastts->lastupdatets' 
      cpu:  'used_mem_avg, used_mem_min, used_mem_max, load_avg, load_min, load_max, usage_avg, usage_min, usage_max,
             used_cores_min,used_cores_avg,used_cores_max,
             used_cores_phys_min,used_cores_phys_avg,used_cores_phys_max,
             used_cores_logic_min,used_cores_logic_avg,used_cores_logic_max,
             currentwatts_avg,currentwatts_min,currentwatts_max'
      gpu:  'gpu_usage_avg,gpu_active_avg,gpu_memu_avg,gpu_memu_max,gpulist,gpuspec,gpu_sclk_max,gpu_pu_avg,gpu_pu_max,
             gpu_clk_max,gpu_temp_avg,gpu_temp_max,gpu_memur_avg,
             gpu_dcgm_up_avg,gpu_dcgm_up_max'
      fabric: 'mbin_min,mbout_min,mbin_max,mbout_max,mbin_avg,mbout_avg,
               pckin_min,pckout_min,pckin_max,pckout_max,pckin_avg,pckout_avg'
      IC:    'icgroupmap'
      fs:    'fs_all_Mbw_sum,fs_all_Mbr_sum,fs_all_MbwR_max,fs_all_MbrR_max,fs_all_ocR_max,
              fs_home_Mbw_sum,fs_home_Mbr_sum,fs_home_MbwR_max,fs_home_MbrR_max,fs_home_ocR_max,
              fs_project_Mbw_sum,fs_project_Mbr_sum,fs_project_MbwR_max,fs_project_MbrR_max,fs_project_ocR_max,
              fs_scratch_Mbw_sum,fs_scratch_Mbr_sum,fs_scratch_MbwR_max,fs_scratch_MbrR_max,fs_scratch_ocR_max,
              fs_fastdata_Mbw_sum,fs_fastdata_Mbr_sum,fs_fastdata_MbwR_max,fs_fastdata_MbrR_max,fs_fastdata_ocR_max'
      rc:    'rc_wallh,rc_rc,rc_signr,rc_state,
              max_rc,nsteps,stepspec,
              nummsgs,numerrnodes,errmsgnodes,errmsgs'
      jmc:   'jmc_numvars->numvars,jmc_names->names,jmc_descs->descs,jmc_minimums->minimums,jmc_maximums->maximums'
      num_datapoints: 'ld_ndps,cores_ndps,gpu_ndps,fs_all_ndps,fs_project_ndps,fs_scratch_ndps,fs_home_ndps,fs_fastdata_ndps,fa_ndps,jmc_ndps'
      files:  'loadmemnodefile,coreusagenodefile,gpunodefile,fabricnodefile,fsallnodefile,fsprojectnodefile,
               fsscratchnodefile,fsfastdatanodefile,fshomenodefile,pdffile,htmlfile,jmcfile'
    column_convert:     'runtimehm->hhmm_short,waittime->hhmm_short,endedhm->todate_std_hhmm,runtime->hourfrac,wallh->hourfrac,wallhm->hhmm_short,
                         runtimeperc->cut2digits,updatetime->todate_std_hhmmss,system->systemname,
                         usage_avg->toPercent,usage_min->toPercent,usage_max->toPercent,
                         fs_all_MbwR_max->cut6digits,fs_all_MbrR_max->cut6digits,fs_all_ocR_max->cut6digits,
                         fs_home_MbwR_max->cut6digits,fs_home_MbrR_max->cut6digits,fs_home_ocR_max->cut6digits,
                         fs_project_MbwR_max->cut6digits,fs_project_MbrR_max->cut6digits,fs_project_ocR_max->cut6digits,
                         fs_scratch_MbwR_max->cut6digits,fs_scratch_MbrR_max->cut6digits,fs_scratch_ocR_max->cut6digits,
                         fs_fastdata_MbwR_max->cut6digits,fs_fastdata_MbrR_max->cut6digits,fs_fastdata_ocR_max->cut6digits,
                         lastupdate->todate_std_hhmmss'

- dataset:
    name:       list_jureptool_json_dat
    set:        json_jureptool
    filepath:   '$outputdir/../tmp/plotlist.dat'
    columns:        'jsonfile'
    order:          'est_work_score desc'
    format:         'dat'
    format_str:      '%s'
    format_header:   '#%s'
    column_ts:       ts
    data_database:   jobreport
    data_table:      jureptool_json
    stat_database:   jobreport_json_meta_stat
    stat_table:      datasetstat_job_jureptool_list
